#!/bin/bash
# Kokoro TTS hook script for Claude
# Only speaks on permission prompts and notifications

KOKORO_URL="http://127.0.0.1:8880/v1/audio/speech"
VOICE="${KOKORO_VOICE:-bm_daniel}"
TMP_FILE="/tmp/claude-kokoro-$$.mp3"

# Read JSON from stdin
INPUT=$(cat)

# Get hook type and notification type
HOOK_EVENT=$(echo "$INPUT" | jq -r '.hook_event_name // empty' 2>/dev/null)
NOTIFICATION_TYPE=$(echo "$INPUT" | jq -r '.notification_type // empty' 2>/dev/null)
MESSAGE=""

case "$HOOK_EVENT" in
    "Notification")
        # Only speak permission prompts and important notifications
        case "$NOTIFICATION_TYPE" in
            "permission_prompt")
                MESSAGE=$(echo "$INPUT" | jq -r '.message // empty' 2>/dev/null)
                ;;
            *)
                # Skip other notification types
                exit 0
                ;;
        esac
        ;;
    "PermissionRequest")
        TOOL=$(echo "$INPUT" | jq -r '.tool_name // empty' 2>/dev/null)
        [ -n "$TOOL" ] && MESSAGE="Permission needed for $TOOL"
        ;;
    "Stop")
        MESSAGE="Task complete"
        ;;
    *)
        # Skip PreToolUse, PostToolUse, etc.
        exit 0
        ;;
esac

# Exit if no message
[ -z "$MESSAGE" ] && exit 0

# Truncate very long messages
if [ ${#MESSAGE} -gt 500 ]; then
    MESSAGE="${MESSAGE:0:497}..."
fi

# Send to Kokoro and play
curl -s "$KOKORO_URL" \
    -H "Content-Type: application/json" \
    -d "$(jq -n --arg text "$MESSAGE" --arg voice "$VOICE" '{model:"kokoro",input:$text,voice:$voice}')" \
    -o "$TMP_FILE" 2>/dev/null

if [ -f "$TMP_FILE" ] && [ -s "$TMP_FILE" ]; then
    afplay "$TMP_FILE" 2>/dev/null
    rm -f "$TMP_FILE"
fi

exit 0
